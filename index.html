<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>فرم درخواست مرخصی</title>
  <link rel="preconnect" href="https://fonts.vazirmatn.ir">
  <link href="https://fonts.vazirmatn.ir/css/Vazirmatn-font-face.css" rel="stylesheet">
  <link rel="stylesheet" href="./css/persian-datepicker.min.css">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Vazirmatn', Tahoma, sans-serif;
      background: #f5f7fa;
      padding: 15px;
      line-height: 1.6;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 25px;
      position: relative;
    }
    .logo {
      position: absolute;
      top: 25px;
      right: 25px;
      width: 90px;
      height: auto;
      border-radius: 6px;
      z-index: 2;
    }
    .form-title {
      text-align: center;
      font-size: 18px;
      color: #2c3e50;
      margin-bottom: 10px;
      font-weight: bold;
    }
    .form-subtitle {
      text-align: center;
      font-size: 18px;
      color: #2c3e50;
      margin-bottom: 25px;
      font-weight: bold;
    }
    .instructions {
      text-align: center;
      background: #f8f9fa;
      padding: 14px;
      border-radius: 8px;
      margin-bottom: 25px;
      font-size: 14px;
      color: #555;
      line-height: 1.6;
    }
    label {
      display: block;
      margin: 18px 0 8px;
      font-weight: bold;
      color: #34495e;
      font-size: 15px;
    }
    input, select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      background: #fdfdfd;
      font-family: 'Vazirmatn', Tahoma, sans-serif;
      color: #888;
    }
    input:focus {
      color: #333;
      outline: none;
      border-color: #aaa;
    }
    input[readonly] {
      background: #f0f0f0;
      cursor: not-allowed;
    }
    button[type="submit"] {
      width: 100%;
      padding: 14px;
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: bold;
      margin-top: 20px;
      cursor: pointer;
      font-family: 'Vazirmatn', Tahoma, sans-serif;
    }
    button[type="submit"]:hover {
      background: #219653;
    }
    .required {
      color: #e74c3c;
    }

    /* ✅ سبک persian-datepicker */
    .p-datepicker-grid-cell {
      width: 36px !important;
      height: 36px !important;
      border-radius: 0 !important;
      font-family: 'Vazirmatn', Tahoma, sans-serif !important;
      font-size: 14px !important;
      background: #fff !important;
      border: 1px solid #eee !important;
    }
    .p-datepicker-grid-cell[data-day-of-week="6"] {
      background-color: #ffebf0 !important;
      color: #c2185b !important;
    }
    .p-datepicker-grid-cell-today {
      background-color: #d4edda !important;
      color: #155724 !important;
      font-weight: bold !important;
    }
    .p-datepicker-grid-cell-selected {
      background-color: #cce5ff !important;
      color: #004085 !important;
      font-weight: bold !important;
    }
    .p-datepicker-grid-cell-holiday {
      background-color: #f8d7da !important;
      color: #721c24 !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="https://i.ibb.co/qMwN3FDw/111.jpg" alt="لوگوی شرکت" class="logo">
    <div class="form-title">فرم درخواست مرخصی ویزیتورهای شرکت</div>
    <div class="form-subtitle">کیاپخش داریوش</div>
    <div class="instructions">
      کلیه ویزیتورهایی که محل ویزیت زمان ارسال درخواست آنها شهرستان می‌باشد می‌توانند از ساعت 7:30 لغایت 14 نسبت به ارسال درخواست مرخصی خود برای فردای کاری اقدام نمایند.<br>
      به کلیه درخواست‌هایی که مغایر با شرایط باشد ترتیب اثر داده نخواهد شد.
    </div>

    <form id="leaveForm">
      <label for="full_name">نام و نام خانوادگی <span class="required">*</span></label>
      <input type="text" id="full_name" name="full_name" required>

      <label for="sales_line">لاین فروش <span class="required">*</span></label>
      <select id="sales_line" name="sales_line" required>
        <option value="">لطفاً انتخاب کنید</option>
        <option value="درنا گروه 1">درنا گروه 1</option>
        <option value="درنا گروه 2">درنا گروه 2</option>
        <option value="سان استار">سان استار</option>
        <option value="زرین آیند">زرین آیند</option>
        <option value="پاکرخ">پاکرخ</option>
        <option value="عمومی">عمومی</option>
      </select>

      <label for="leave_type">نوع مرخصی <span class="required">*</span></label>
      <select id="leave_type" name="leave_type" required>
        <option value="">لطفاً انتخاب کنید</option>
        <option value="مرخصی استحقاقی">مرخصی استحقاقی</option>
        <option value="مرخصی ساعتی">مرخصی ساعتی</option>
      </select>

      <!-- ✅ فیلدهای مرخصی استحقاقی -->
      <div id="dailyFields" style="display: none;">
        <label for="start_date">تاریخ شروع مرخصی (شمسی) <span class="required">*</span></label>
        <input type="text" id="start_date" name="start_date" placeholder="1400/01/01" required readonly>

        <label for="end_date">تاریخ پایان مرخصی (شمسی) <span class="required">*</span></label>
        <input type="text" id="end_date" name="end_date" placeholder="1400/01/01" required readonly>

        <label for="duration_days">مدت مرخصی (روز) <span class="required">*</span></label>
        <input type="text" id="duration_days" name="duration_days" readonly>
      </div>

      <!-- ✅ فیلدهای مرخصی ساعتی -->
      <div id="hourlyFields" style="display: none;">
        <label for="leave_date_hourly">تاریخ مرخصی ساعتی (شمسی) <span class="required">*</span></label>
        <input type="text" id="leave_date_hourly" name="leave_date_hourly" placeholder="1400/01/01" required readonly>

        <label for="start_time">مرخصی از ساعت <span class="required">*</span></label>
        <input type="text" id="start_time" name="start_time" placeholder="08:30" required>

        <label for="end_time">مرخصی تا ساعت <span class="required">*</span></label>
        <input type="text" id="end_time" name="end_time" placeholder="14:00" required>

        <label for="duration_hours">مدت ساعت مرخصی <span class="required">*</span></label>
        <input type="text" id="duration_hours" name="duration_hours" readonly>
      </div>

      <label for="visit_city_request_day">شهر محل ویزیت روز درخواست مرخصی <span class="required">*</span></label>
      <select id="visit_city_request_day" name="visit_city_request_day" required>
        <option value="">لطفاً انتخاب کنید</option>
        <option value="کرمانشاه">کرمانشاه</option>
        <option value="اسلام‌آباد غرب">اسلام‌آباد غرب</option>
        <option value="پاوه">پاوه</option>
        <option value="جوانرود">جوانرود</option>
        <option value="روانسر">روانسر</option>
        <option value="سرپل ذهاب">سرپل ذهاب</option>
        <option value="سنقر">سنقر</option>
        <option value="صحنه">صحنه</option>
        <option value="قصر شیرین">قصر شیرین</option>
        <option value="کنگاور">کنگاور</option>
        <option value="گیلان‌غرب">گیلان‌غرب</option>
        <option value="هرسین">هرسین</option>
        <option value="فیروزآباد">فیروزآباد</option>
        <option value="شاهو">شاهو</option>
        <option value="کوزران">کوزران</option>
        <option value="نودشه">نودشه</option>
        <option value="ریجاب">ریجاب</option>
        <option value="کرند غرب">کرند غرب</option>
        <option value="سرمست">سرمست</option>
      </select>

      <label for="visit_city_leave_day">شهر محل ویزیت روز مرخصی <span class="required">*</span></label>
      <select id="visit_city_leave_day" name="visit_city_leave_day" required>
        <option value="">لطفاً انتخاب کنید</option>
        <option value="کرمانشاه">کرمانشاه</option>
        <option value="اسلام‌آباد غرب">اسلام‌آباد غرب</option>
        <option value="پاوه">پاوه</option>
        <option value="جوانرود">جوانرود</option>
        <option value="روانسر">روانسر</option>
        <option value="سرپل ذهاب">سرپل ذهاب</option>
        <option value="سنقر">سنقر</option>
        <option value="صحنه">صحنه</option>
        <option value="قصر شیرین">قصر شیرین</option>
        <option value="کنگاور">کنگاور</option>
        <option value="گیلان‌غرب">گیلان‌غرب</option>
        <option value="هرسین">هرسین</option>
        <option value="فیروزآباد">فیروزآباد</option>
        <option value="شاهو">شاهو</option>
        <option value="کوزران">کوزران</option>
        <option value="نودشه">نودشه</option>
        <option value="ریجاب">ریجاب</option>
        <option value="کرند غرب">کرند غرب</option>
        <option value="سرمست">سرمست</option>
      </select>

      <label for="telegram_id">آیدی تلگرام (اختیاری)</label>
      <input type="text" id="telegram_id" name="telegram_id" placeholder="مثال: 123456789">

      <button type="submit">ارسال درخواست</button>
    </form>
  </div>

  <!-- ✅ persian-datepicker -->
  <script src="./js/persian-datepicker.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ✅ تنظیمات تقویم
      const datePickerConfig = {
        format: 'YYYY/MM/DD',
        autoClose: true,
        minDate: [1400, 1, 1],
        maxDate: [1499, 12, 29],
        calendar: {
          persian: {
            locale: 'fa',
            holidays: [
              [1,1], [1,2], [1,3], [1,4], [1,12], [1,13],
              [3,14], [3,15], [11,22], [12,29]
            ]
          }
        },
        highlightToday: true,
        markHolidays: true,
        disableHolidays: true,
        toolbox: {
          todayButton: { enabled: true }
        }
      };

      // ✅ فعال‌سازی تقویم
      new pDatepicker('#start_date', datePickerConfig);
      new pDatepicker('#end_date', datePickerConfig);
      new pDatepicker('#leave_date_hourly', datePickerConfig);

      // ✅ toggle فیلدها
      const leaveType = document.getElementById('leave_type');
      const dailyFields = document.getElementById('dailyFields');
      const hourlyFields = document.getElementById('hourlyFields');

      leaveType.addEventListener('change', () => {
        if (leaveType.value === 'مرخصی استحقاقی') {
          dailyFields.style.display = 'block';
          hourlyFields.style.display = 'none';
        } else if (leaveType.value === 'مرخصی ساعتی') {
          dailyFields.style.display = 'none';
          hourlyFields.style.display = 'block';
        } else {
          dailyFields.style.display = 'none';
          hourlyFields.style.display = 'none';
        }
      });

      // ✅ محاسبه مدت
      function calculateDuration() {
        const s = document.getElementById('start_date').value.trim();
        const e = document.getElementById('end_date').value.trim();
        const f = document.getElementById('duration_days');
        if (!s || !e) return f.value = '';
        const [sy, sm, sd] = s.split('/').map(Number);
        const [ey, em, ed] = e.split('/').map(Number);
        if (isNaN(sy) || isNaN(ey)) return f.value = '';
        const sJDN = sy * 365 + sm * 30 + sd;
        const eJDN = ey * 365 + em * 30 + ed;
        f.value = (eJDN >= sJDN) ? (eJDN - sJDN + 1) : '';
      }

      function calculateHourlyDuration() {
        const st = document.getElementById('start_time').value;
        const et = document.getElementById('end_time').value;
        const f = document.getElementById('duration_hours');
        if (!st || !et) return f.value = '';
        const regex = /^([0-1]?[0-9]|2[0-3]):([0-5]?[0-9])$/;
        if (!regex.test(st) || !regex.test(et)) return f.value = '';
        const [sh, sm] = st.split(':').map(Number);
        const [eh, em] = et.split(':').map(Number);
        if (isNaN(sh) || isNaN(sm) || isNaN(eh) || isNaN(em)) return f.value = '';
        const startMins = sh * 60 + sm;
        const endMins = eh * 60 + em;
        if (endMins <= startMins) return f.value = '';
        f.value = ((endMins - startMins) / 60).toFixed(1);
      }

      // ✅ اتصال رویدادها
      document.getElementById('start_date').addEventListener('change', calculateDuration);
      document.getElementById('end_date').addEventListener('change', calculateDuration);
      document.getElementById('start_time').addEventListener('input', calculateHourlyDuration);
      document.getElementById('end_time').addEventListener('input', calculateHourlyDuration);

      // ✅ ارسال فرم
      document.getElementById('leaveForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const todayShamsi = new Intl.DateTimeFormat('fa-IR-u-ca-persian', {
          year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'Asia/Tehran'
        }).format(new Date()).replace(/\s+/g, '').replace(/٫/g, '/');

        const data = new FormData(e.target);
        data.append('today_shamsi', todayShamsi);

        try {
          const res = await fetch('https://kiapakhsh.app.n8n.cloud/webhook/leave', {
            method: 'POST',
            body: JSON.stringify(Object.fromEntries(data)),
            headers: { 'Content-Type': 'application/json' }
          });
          const result = await res.json();
          alert(result.message || "خطای ناشناخته");
          if (res.ok && result.status === "success") {
            e.target.reset();
            dailyFields.style.display = 'none';
            hourlyFields.style.display = 'none';
          }
        } catch (err) {
          alert("❌ ارتباط با سرور برقرار نشد.");
        }
      });
    });
  </script>
</body>
</html>
